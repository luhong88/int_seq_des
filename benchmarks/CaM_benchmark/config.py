import os
from pgen.esm_sampler import ESM_sampler
from pgen.likelihood_esm import model_map

from int_seq_des.protein import Residue, TiedResidue, DesignSequence, Chain
from int_seq_des.wrapper import ObjectiveAF2Rank, ObjectiveESM, ObjectiveProteinMPNNNegLogProb
from int_seq_des.af_model import get_af_model_parameters


# specify absolute paths; update according to local setups
tmscore_exec= '/wynton/home/kortemme/lhong/software/TMscore/TMscore'
af2_params_dir= '/wynton/home/kortemme/lhong/software/af2rank/params'
protein_mpnn_helper_scripts_dir= '/wynton/home/kortemme/lhong/ProteinMPNN-main/helper_scripts'
protein_mpnn_weights_dir= '/wynton/home/kortemme/lhong/ProteinMPNN-main/vanilla_model_weights'
pdb_files_dir= f'{os.getcwd()}/pdb_files'
temp_dir= '/wynton/scratch/'

# define CaM & design parameters
weights_list= [1.]*16
CaM_chain_ids= ['A', 'B', 'D', 'F', 'G', 'J', 'L', 'M', 'O', 'R', 'T', 'V', 'Y', 'Z', 'b', 'd']

# The N-terminal Methionine is removed and not counted in resid
CaM_WT_seq= 'ADQLTEEQIAEFKEAFSLFDKDGDGTITTKELGTVMRSLGQNPTEAELQDMINEVDADGNGTIDFPEFLTMMARKMKDTDSEEEIREAFRVFDKDGNGYISAAELRHVMTNLGEKLTDEEVDEMIREADIDGDGQVNYEEFVQMMTAK'

# design 6-145, (now including the middle linker 73 to 84), exclude Ca binding res 
# 20, 22, 24, 31, 56, 58, 60, 67, 93, 95, 97, 104, 129, 131, 133, 140
# there are four res that coordinate with Ca through their backbone, which are allowed to redesign
des_resids= [
    6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 21, 23, 25, 26, 27, 28, 
    29, 30, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 
    49, 50, 51, 52, 53, 54, 55, 57, 59, 61, 62, 63, 64, 65, 66, 68, 69, 70, 71, 
    72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 
    91, 92, 94, 96, 98, 99, 100, 101, 102, 103, 105, 106, 107, 108, 109, 110, 
    111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 
    126, 127, 128, 130, 132, 134, 135, 136, 137, 138, 139, 141, 142, 143, 144, 145
]

tied_res_list= [
    TiedResidue(*[
        Residue(chain_id, resid, weight)
        for chain_id, weight in zip(
            CaM_chain_ids, 
            weights_list,
            strict= True
        )
    ])
    for resid in des_resids
]

tied_design_seq= DesignSequence(*tied_res_list)

chain_design_seq_dict= {
    chain_id:  DesignSequence(*[Residue(chain_id, resid, 1.0) for resid in des_resids])
    for chain_id in CaM_chain_ids
}


chains_list= [
    #1CFD: CaM (chain A)
    Chain(
        chain_id= 'A', init_resid= 1, fin_resid= 148,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    #1CFF: CaM (chain B), ATP2B4 (chain C)
    Chain(
        chain_id= 'B', init_resid= 1, fin_resid= 148,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'C', init_resid= 1086, fin_resid= 1104,
        internal_missing_res_list= [], 
        full_seq= 'MTNPSDRVLPANSMAESREGDFGCTVMELRKLMELRSRDALTQINVHYGGVQNLCSRLKTSPVEGLSGNPADLEKRRQVFGHNVIPPKKPKTFLELVWEALQDVTLIILEIAAIISLVLSFYRPAGEENELCGQVATTPEDENEAQAGWIEGAAILFSVIIVVLVTAFNDWSKEKQFRGLQCRIEQEQKFSIIRNGQLIQLPVAEIVVGDIAQVKYGDLLPADGILIQGNDLKIDESSLTGESDHVKKSLDKDPMLLSGTHVMEGSGRMVVTAVGVNSQTGIILTLLGVNEDDEGEKKKKGKKQGVPENRNKAKTQDGVALEIQPLNSQEGIDNEEKDKKAVKVPKKEKSVLQGKLTRLAVQIGKAGLLMSALTVFILILYFVIDNFVINRRPWLPECTPIYIQYFVKFFIIGITVLVVAVPEGLPLAVTISLAYSVKKMMKDNNLVRHLDACETMGNATAICSDKTGTLTMNRMTVVQAYIGGIHYRQIPSPDVFLPKVLDLIVNGISINSAYTSKILPPEKEGGLPRQVGNKTECALLGFVTDLKQDYQAVRNEVPEEKLYKVYTFNSVRKSMSTVIRNPNGGFRMYSKGASEIILRKCNRILDRKGEAVPFKNKDRDDMVRTVIEPMACDGLRTICIAYRDFDDTEPSWDNENEILTELTCIAVVGIEDPVRPEVPDAIAKCKQAGITVRMVTGDNINTARAIATKCGILTPGDDFLCLEGKEFNRLIRNEKGEVEQEKLDKIWPKLRVLARSSPTDKHTLVKGIIDSTVGEHRQVVAVTGDGTNDGPALKKADVGFAMGIAGTDVAKEASDIILTDDNFTSIVKAVMWGRNVYDSISKFLQFQLTVNVVAVIVAFTGACITQDSPLKAVQMLWVNLIMDTFASLALATEPPTESLLKRRPYGRNKPLISRTMMKNILGHAFYQLIVIFILVFAGEKFFDIDSGRKAPLHSPPSQHYTIVFNTFVLMQLFNEINSRKIHGEKNVFSGIYRNIIFCSVVLGTFICQIFIVEFGGKPFSCTSLSLSQWLWCLFIGIGELLWGQFISAIPTRSLKFLKEAGHGTTKEEITKDAEGLDEIDHAEMELRRGQILWFRGLNRIQTQIDVINTFQTGASFKGVLRRQNMGQHLDVKLVPSSSYIKVVKAFHSSLHESIQKPYNQKSIHSFMTHPEFAIEEELPRTPLLDEEEEENPDKASKFGTRVLLLDGEVTPYANTNNNAVDCNQVQLPQSDSSLQSLETSV'
    ),
    #1CKK: CaM (chain D), CaMKK1 (chain E)
    Chain(
        chain_id= 'D', init_resid= 1, fin_resid= 148,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'E', init_resid= 438, fin_resid= 463,
        internal_missing_res_list= [], 
        full_seq= 'MERSPAVCCQDPRAELVERVAAISVAHLEEAEEGPEPASNGVDPPPRARAASVIPGSASRPTPVRPSLSARKFSLQERPAGSCLEAQVGPYSTGPASHMSPRAWRRPTIESHHVAISDTEDCVQLNQYKLQSEIGKGAYGVVRLAYNEREDRHYAMKVLSKKKLLKQYGFPRRPPPRGSQAPQGGPAKQLLPLERVYQEIAILKKLDHVNVVKLIEVLDDPAEDNLYLVFDLLRKGPVMEVPCDKPFPEEQARLYLRDIILGLEYLHCQKIVHRDIKPSNLLLGDDGHVKIADFGVSNQFEGNDAQLSSTAGTPAFMAPEAISDTGQSFSGKALDVWATGVTLYCFVYGKCPFIDEYILALHRKIKNEAVVFPEEPEVSEELKDLILKMLDKNPETRIGVSDIKLHPWVTKHGEEPLPSEEEHCSVVEVTEEEVKNSVKLIPSWTTVILVKSMLRKRSFGNPFEPQARREERSMSAPGNLLLKEGCGEGGKSPELPGVQEDEAAS'
    ),
    #1CLL: CaM (chain F)
    Chain(
        chain_id= 'F', init_resid= 4, fin_resid= 147,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    #1CM1: CaM (chain G), CaMK2alpha (chain H)
    Chain(
        chain_id= 'G', init_resid= 4, fin_resid= 146,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'H', init_resid= 293, fin_resid= 310,
        internal_missing_res_list= [], 
        full_seq= 'MATITCTRFTEEYQLFEELGKGAFSVVRRCVKVLAGQEYAAKIINTKKLSARDHQKLEREARICRLLKHPNIVRLHDSISEEGHHYLIFDLVTGGELFEDIVAREYYSEADASHCIQQILEAVLHCHQMGVVHRDLKPENLLLASKLKGAAVKLADFGLAIEVEGEQQAWFGFAGTPGYLSPEVLRKDPYGKPVDLWACGVILYILLVGYPPFWDEDQHRLYQQIKAGAYDFPSPEWDTVTPEAKDLINKMLTINPSKRITAAEALKHPWISHRSTVASCMHRQETVDCLKKFNARRKLKGAILTTMLATRNFSGGKSGGNKKNDGVKESSESTNTTIEDEDTKVRKQEIIKVTEQLIEAISNGDFESYTKMCDPGMTAFEPEALGNLVEGLDFHRFYFENLWSRNSKPVHTTILNPHIHLMGDESACIAYIRITQYLDAGGIPRTAQSEETRVWHRRDGKWQIVHFHRSGAPSVLPH'
    ),
    #1G4Y: CaM (chain J, L), KCNN2 (chain I, K)
    Chain(
        chain_id= 'I', init_resid= 413, fin_resid= 487,
        internal_missing_res_list= [], 
        full_seq= 'MSSCRYNGGVMRPLSNLSSSRRNLHEMDSEAQPLQPPASVVGGGGGASSPSAAAAASSSAPEIVVSKPEHNNSNNLALYGTGGGGSTGGGGGGGGGGGGSGHGSSSGTKSSKKKNQNIGYKLGHRRALFEKRKRLSDYALIFGMFGIVVMVIETELSWGAYDKASLYSLALKCLISLSTIILLGLIIVYHAREIQLFMVDNGADDWRIAMTYERIFFICLEILVCAIHPIPGNYTFTWTARLAFSYAPSTTTADVDIILSIPMFLRLYLIARVMLLHSKLFTDASSRSIGALNKINFNTRFVMKTLMTICPGTVLLVFSISLWIIAAWTVRACERYHDQQDVTSNFLGAMWLISITFLSIGYGDMVPNTYCGKGVCLLTGIMGAGCTALVVAVVARKLELTKAEKHVHNFMMDTQLTKRVKNAAANVLRETWLIYKNTKLVKKIDHAKVRKHQRKFLQAIHQLRSVKMEQRKLNDQANTLVDLAKTQNIMYDMISDLNERSEDFEKRIVTLETKLETLIGSIHALPGLISQTIRQQQRDFIETQMENYDKHVTYNAERSRSSSRRRRSSSTAPPTSSESS'
    ),
    Chain(
        chain_id= 'J', init_resid= 1, fin_resid= 147,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'K', init_resid= 413, fin_resid= 487,
        internal_missing_res_list= [], 
        full_seq= 'MSSCRYNGGVMRPLSNLSSSRRNLHEMDSEAQPLQPPASVVGGGGGASSPSAAAAASSSAPEIVVSKPEHNNSNNLALYGTGGGGSTGGGGGGGGGGGGSGHGSSSGTKSSKKKNQNIGYKLGHRRALFEKRKRLSDYALIFGMFGIVVMVIETELSWGAYDKASLYSLALKCLISLSTIILLGLIIVYHAREIQLFMVDNGADDWRIAMTYERIFFICLEILVCAIHPIPGNYTFTWTARLAFSYAPSTTTADVDIILSIPMFLRLYLIARVMLLHSKLFTDASSRSIGALNKINFNTRFVMKTLMTICPGTVLLVFSISLWIIAAWTVRACERYHDQQDVTSNFLGAMWLISITFLSIGYGDMVPNTYCGKGVCLLTGIMGAGCTALVVAVVARKLELTKAEKHVHNFMMDTQLTKRVKNAAANVLRETWLIYKNTKLVKKIDHAKVRKHQRKFLQAIHQLRSVKMEQRKLNDQANTLVDLAKTQNIMYDMISDLNERSEDFEKRIVTLETKLETLIGSIHALPGLISQTIRQQQRDFIETQMENYDKHVTYNAERSRSSSRRRRSSSTAPPTSSESS'
    ),
    Chain(
        chain_id= 'L', init_resid= 1, fin_resid= 147,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    #1NIW: CaM (chain M), NOS3 (chain N)
    Chain(
        chain_id= 'M', init_resid= 3, fin_resid= 147,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'N', init_resid= 492, fin_resid= 510,
        internal_missing_res_list= [], 
        full_seq= 'MGNLKSVAQEPGPPCGLGLGLGLGLCGKQGPATPAPEPSRAPASLLPPAPEHSPPSSPLTQPPEGPKFPRVKNWEVGSITYDTLSAQAQQDGPCTPRRCLGSLVFPRKLQGRPSPGPPAPEQLLSQARDFINQYYSSIKRSGSQAHEQRLQEVEAEVAATGTYQLRESELVFGAKQAWRNAPRCVGRIQWGKLQVFDARDCRSAQEMFTYICNHIKYATNRGNLRSAITVFPQRCPGRGDFRIWNSQLVRYAGYRQQDGSVRGDPANVEITELCIQHGWTPGNGRFDVLPLLLQAPDDPPELFLLPPELVLEVPLEHPTLEWFAALGLRWYALPAVSNMLLEIGGLEFPAAPFSGWYMSTEIGTRNLCDPHRYNILEDVAVCMDLDTRTTSSLWKDKAAVEINVAVLHSYQLAKVTIVDHHAATASFMKHLENEQKARGGCPADWAWIVPPISGSLTPVFHQEMVNYFLSPAFRYQPDPWKGSAAKGTGITRKKTFKEVANAVKISASLMGTVMAKRVKATILYGSETGRAQSYAQQLGRLFRKAFDPRVLCMDEYDVVSLEHETLVLVVTSTFGNGDPPENGESFAAALMEMSGPYNSSPRPEQHKSYKIRFNSISCSDPLVSSWRRKRKESSNTDSAGALGTLRFCVFGLGSRAYPHFCAFARAVDTRLEELGGERLLQLGQGDELCGQEEAFRGWAQAAFQAACETFCVGEDAKAAARDIFSPKRSWKRQRYRLSAQAEGLQLLPGLIHVHRRKMFQATIRSVENLQSSKSTRATILVRLDTGGQEGLQYQPGDHIGVCPPNRPGLVEALLSRVEDPPAPTEPVAVEQLEKGSPGGPPPGWVRDPRLPPCTLRQALTFFLDITSPPSPQLLRLLSTLAEEPREQQELEALSQDPRRYEEWKWFRCPTLLEVLEQFPSVALPAPLLLTQLPLLQPRYYSVSSAPSTHPGEIHLTVAVLAYRTQDGLGPLHYGVCSTWLSQLKPGDPVPCFIRGAPSFRLPPDPSLPCILVGPGTGIAPFRGFWQERLHDIESKGLQPTPMTLVFGCRCSQLDHLYRDEVQNAQQRGVFGRVLTAFSREPDNPKTYVQDILRTELAAEVHRVLCLERGHMFVCGDVTMATNVLQTVQRILATEGDMELDEAGDVIGVLRDQQRYHEDIFGLTLRTQEVTSRIRTQSFSLQERQLRGAVPWAFDPPGSDTNSP'
    ),
    #1NWD: CaM (chain O), GAD (chain P, Q)
    Chain(
        chain_id= 'O', init_resid= 1, fin_resid= 148,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'P', init_resid= 470, fin_resid= 495,
        internal_missing_res_list= [], 
        full_seq= 'MVLSKTVSQSDVSIHSTFASRYVRTSLPRFKMPDNSIPKEAAYQIINDELMLDGNPRLNLASFVTTWMEPECDKLMMDSINKNYVDMDEYPVTTELQNRCVNMIAHLFNAPLEDGETAVGVGTVGSSEAIMLAGLAFKRKWQNKMKAQGKPCDKPNIVTGANVQVCWEKFARYFEVELKEVKLSEGYYVMDPEKAVEMVDENTICVAAILGSTLNGEFEDVKRLNDLLVEKNKETGWDTPIHVDAASGGFIAPFIYPELEWDFRLPLVKSINVSGHKYGLVYAGIGWVVWRNKDDLPDELIFHINYLGADQPTFTLNFSKGSSQVIAQYYQLIRLGYEGYKNVMENCQENASVLREGLEKTGRFNIISKEIGVPLVAFSLKDNRQHNEFEISETLRRFGWIVPAYTMPPNAQHITVLRVVIREDFSRTLAERLVRDIEKVLHELDTLPARVNAKLAVAEEQAAANGSEVHKKTDSEVQLEMITAWKKFVEEKKKKTNRVC'
    ),
    Chain(
        chain_id= 'Q', init_resid= 470, fin_resid= 495,
        internal_missing_res_list= [], 
        full_seq= 'MVLSKTVSQSDVSIHSTFASRYVRTSLPRFKMPDNSIPKEAAYQIINDELMLDGNPRLNLASFVTTWMEPECDKLMMDSINKNYVDMDEYPVTTELQNRCVNMIAHLFNAPLEDGETAVGVGTVGSSEAIMLAGLAFKRKWQNKMKAQGKPCDKPNIVTGANVQVCWEKFARYFEVELKEVKLSEGYYVMDPEKAVEMVDENTICVAAILGSTLNGEFEDVKRLNDLLVEKNKETGWDTPIHVDAASGGFIAPFIYPELEWDFRLPLVKSINVSGHKYGLVYAGIGWVVWRNKDDLPDELIFHINYLGADQPTFTLNFSKGSSQVIAQYYQLIRLGYEGYKNVMENCQENASVLREGLEKTGRFNIISKEIGVPLVAFSLKDNRQHNEFEISETLRRFGWIVPAYTMPPNAQHITVLRVVIREDFSRTLAERLVRDIEKVLHELDTLPARVNAKLAVAEEQAAANGSEVHKKTDSEVQLEMITAWKKFVEEKKKKTNRVC'
    ),
    #2F2P: CaM (chain R, T), PPP3Calpha (chain S, U)
    Chain(
        chain_id= 'R', init_resid= 2, fin_resid= 147,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'S', init_resid= 389, fin_resid= 411,
        internal_missing_res_list= [], 
        full_seq= 'MSEPKAIDPKLSTTDRVVKAVPFPPSHRLTAKEVFDNDGKPRVDILKAHLMKEGRLEETVALRIITEGASILRQEKNLLDIDAPVTVCGDIHGQFFDLMKLFEVGGSPANTRYLFLGDYVDRGYFSIECVLYLWALKILYPKTLFLLRGNHECRHLTEYFTFKQECKIKYSERVYDACMDAFDCLPLAALMNQQFLCVHGGLSPEINTLDDIRKLDRFKEPPAYGPMCDILWSDPLEDFGNEKTQEHFTHNTVRGCSYFYSYPAVCEFLQHNNLLSILRAHEAQDAGYRMYRKSQTTGFPSLITIFSAPNYLDVYNNKAAVLKYENNVMNIRQFNCSPHPYWLPNFMDVFTWSLPFVGEKVTEMLVNVLNICSDDELGSEEDGFDGATAAARKEVIRNKIRAIGKMARVFSVLREESESVLTLKGLTPTGMLPSGVLSGGKQTLQSATVEAIEADEAIKGFSPQHKITSFEEAKGLDRINERMPPRRDAMPSDANLNSINKALASETNGTDSNGSNSSNIQ'
    ),
    Chain(
        chain_id= 'T', init_resid= 2, fin_resid= 147,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'U', init_resid= 389, fin_resid= 411,
        internal_missing_res_list= [], 
        full_seq= 'MSEPKAIDPKLSTTDRVVKAVPFPPSHRLTAKEVFDNDGKPRVDILKAHLMKEGRLEETVALRIITEGASILRQEKNLLDIDAPVTVCGDIHGQFFDLMKLFEVGGSPANTRYLFLGDYVDRGYFSIECVLYLWALKILYPKTLFLLRGNHECRHLTEYFTFKQECKIKYSERVYDACMDAFDCLPLAALMNQQFLCVHGGLSPEINTLDDIRKLDRFKEPPAYGPMCDILWSDPLEDFGNEKTQEHFTHNTVRGCSYFYSYPAVCEFLQHNNLLSILRAHEAQDAGYRMYRKSQTTGFPSLITIFSAPNYLDVYNNKAAVLKYENNVMNIRQFNCSPHPYWLPNFMDVFTWSLPFVGEKVTEMLVNVLNICSDDELGSEEDGFDGATAAARKEVIRNKIRAIGKMARVFSVLREESESVLTLKGLTPTGMLPSGVLSGGKQTLQSATVEAIEADEAIKGFSPQHKITSFEEAKGLDRINERMPPRRDAMPSDANLNSINKALASETNGTDSNGSNSSNIQ'
    ),
    #2N8J: CaM (chain V), NOS3 (chain W)
    Chain(
        chain_id= 'V', init_resid= 1, fin_resid= 148,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'W', init_resid= 491, fin_resid= 512,
        internal_missing_res_list= [], 
        full_seq= 'MGNLKSVAQEPGPPCGLGLGLGLGLCGKQGPATPAPEPSRAPASLLPPAPEHSPPSSPLTQPPEGPKFPRVKNWEVGSITYDTLSAQAQQDGPCTPRRCLGSLVFPRKLQGRPSPGPPAPEQLLSQARDFINQYYSSIKRSGSQAHEQRLQEVEAEVAATGTYQLRESELVFGAKQAWRNAPRCVGRIQWGKLQVFDARDCRSAQEMFTYICNHIKYATNRGNLRSAITVFPQRCPGRGDFRIWNSQLVRYAGYRQQDGSVRGDPANVEITELCIQHGWTPGNGRFDVLPLLLQAPDDPPELFLLPPELVLEVPLEHPTLEWFAALGLRWYALPAVSNMLLEIGGLEFPAAPFSGWYMSTEIGTRNLCDPHRYNILEDVAVCMDLDTRTTSSLWKDKAAVEINVAVLHSYQLAKVTIVDHHAATASFMKHLENEQKARGGCPADWAWIVPPISGSLTPVFHQEMVNYFLSPAFRYQPDPWKGSAAKGTGITRKKTFKEVANAVKISASLMGTVMAKRVKATILYGSETGRAQSYAQQLGRLFRKAFDPRVLCMDEYDVVSLEHETLVLVVTSTFGNGDPPENGESFAAALMEMSGPYNSSPRPEQHKSYKIRFNSISCSDPLVSSWRRKRKESSNTDSAGALGTLRFCVFGLGSRAYPHFCAFARAVDTRLEELGGERLLQLGQGDELCGQEEAFRGWAQAAFQAACETFCVGEDAKAAARDIFSPKRSWKRQRYRLSAQAEGLQLLPGLIHVHRRKMFQATIRSVENLQSSKSTRATILVRLDTGGQEGLQYQPGDHIGVCPPNRPGLVEALLSRVEDPPAPTEPVAVEQLEKGSPGGPPPGWVRDPRLPPCTLRQALTFFLDITSPPSPQLLRLLSTLAEEPREQQELEALSQDPRRYEEWKWFRCPTLLEVLEQFPSVALPAPLLLTQLPLLQPRYYSVSSAPSTHPGEIHLTVAVLAYRTQDGLGPLHYGVCSTWLSQLKPGDPVPCFIRGAPSFRLPPDPSLPCILVGPGTGIAPFRGFWQERLHDIESKGLQPTPMTLVFGCRCSQLDHLYRDEVQNAQQRGVFGRVLTAFSREPDNPKTYVQDILRTELAAEVHRVLCLERGHMFVCGDVTMATNVLQTVQRILATEGDMELDEAGDVIGVLRDQQRYHEDIFGLTLRTQEVTSRIRTQSFSLQERQLRGAVPWAFDPPGSDTNSP'
    ),
    #2WEL: CaM (chain Y), CamKIIdelta (chain X)
    Chain(
        chain_id= 'X', init_resid= 293, fin_resid= 315,
        internal_missing_res_list= [], 
        full_seq= 'MASTTTCTRFTDEYQLFEELGKGAFSVVRRCMKIPTGQEYAAKIINTKKLSARDHQKLEREARICRLLKHPNIVRLHDSISEEGFHYLVFDLVTGGELFEDIVAREYYSEADASHCIQQILESVNHCHLNGIVHRDLKPENLLLASKSKGAAVKLADFGLAIEVQGDQQAWFGFAGTPGYLSPEVLRKDPYGKPVDMWACGVILYILLVGYPPFWDEDQHRLYQQIKAGAYDFPSPEWDTVTPEAKDLINKMLTINPAKRITASEALKHPWICQRSTVASMMHRQETVDCLKKFNARRKLKGAILTTMLATRNFSAAKSLLKKPDGVKESTESSNTTIEDEDVKARKQEIIKVTEQLIEAINNGDFEAYTKICDPGLTAFEPEALGNLVEGMDFHRFYFENALSKSNKPIHTIILNPHVHLVGDDAACIAYIRLTQYMDGSGMPKTMQSEETRVWHRRDGKWQNVHFHRSGSPTVPIKPPCIPNGKENFSGGTSLWQNI'
    ),
    Chain(
        chain_id= 'Y', init_resid= 2, fin_resid= 146,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    #3EWT: CaM (chain Z), TNFRSF6 (chain a)
    Chain(
        chain_id= 'Z', init_resid= 1, fin_resid= 145,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'a', init_resid= 230, fin_resid= 243,
        internal_missing_res_list= [], 
        full_seq= 'MLGIWTLLPLVLTSVARLSSKSVNAQVTDINSKGLELRKTVTTVETQNLEGLHHDGQFCHKPCPPGERKARDCTVNGDEPDCVPCQEGKEYTDKAHFSSKCRRCRLCDEGHGLEVEINCTRTQNTKCRCKPNFFCNSTVCEHCDPCTKCEHGIIKECTLTSNTKCKEEGSRSNLGWLCLLLLPIPLIVWVKRKEVQKTCRKHRKENQGSHESPTLNPETVAINLSDVDLSKYITTIAGVMTLSQVKGFVRKNGVNEAKIDEIKNDNVQDTAEQKVQLLRNWHQLHGKKEAYDTLIKDLKKANLCTLAEKIQTIILKDITSDSENSNFRNEIQSLV'
    ),
    #3EWV: CaM (chain b), TNFRSF16 (chain c)
    Chain(
        chain_id= 'b', init_resid= 4, fin_resid= 148,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'c', init_resid= 396, fin_resid= 412,
        internal_missing_res_list= [], 
        full_seq= 'MGAGATGRAMDGPRLLLLLLLGVSLGGAKEACPTGLYTHSGECCKACNLGEGVAQPCGANQTVCEPCLDSVTFSDVVSATEPCKPCTECVGLQSMSAPCVEADDAVCRCAYGYYQDETTGRCEACRVCEAGSGLVFSCQDKQNTVCEECPDGTYSDEANHVDPCLPCTVCEDTERQLRECTRWADAECEEIPGRWITRSTPPEGSDSTAPSTQEPEAPPEQDLIASTVAGVVTTVMGSSQPVVTRGTTDNLIPVYCSILAAVVVGLVAYIAFKRWNSCKQNKQGANSRPVNQTPPPEGEKLHSDSGISVDSQSLHDQQPHTQTASGQALKGDGGLYSSLPPAKREEVEKLLNGSAGDTWRHLAGELGYQPEHIDSFTHEACPVRALLASWATQDSATLDALLAALRRIQRADLVESLCSESTATSPV'
    ),
    #4DJC: CaM (chain d), NaV1.5/SCN5A (chain e)
    Chain(
        chain_id= 'd', init_resid= 1, fin_resid= 148,
        internal_missing_res_list= [], full_seq= CaM_WT_seq
    ),
    Chain(
        chain_id= 'e', init_resid= 1491, fin_resid= 1501,
        internal_missing_res_list= [], 
        full_seq= 'MANFLLPRGTSSFRRFTRESLAAIEKRMAEKQARGSTTLQESREGLPEEEAPRPQLDLQASKKLPDLYGNPPQELIGEPLEDLDPFYSTQKTFIVLNKGKTIFRFSATNALYVLSPFHPIRRAAVKILVHSLFNMLIMCTILTNCVFMAQHDPPPWTKYVEYTFTAIYTFESLVKILARGFCLHAFTFLRDPWNWLDFSVIIMAYTTEFVDLGNVSALRTFRVLRALKTISVISGLKTIVGALIQSVKKLADVMVLTVFCLSVFALIGLQLFMGNLRHKCVRNFTALNGTNGSVEADGLVWESLDLYLSDPENYLLKNGTSDVLLCGNSSDAGTCPEGYRCLKAGENPDHGYTSFDSFAWAFLALFRLMTQDCWERLYQQTLRSAGKIYMIFFMLVIFLGSFYLVNLILAVVAMAYEEQNQATIAETEEKEKRFQEAMEMLKKEHEALTIRGVDTVSRSSLEMSPLAPVNSHERRSKRRKRMSSGTEECGEDRLPKSDSEDGPRAMNHLSLTRGLSRTSMKPRSSRGSIFTFRRRDLGSEADFADDENSTAGESESHHTSLLVPWPLRRTSAQGQPSPGTSAPGHALHGKKNSTVDCNGVVSLLGAGDPEATSPGSHLLRPVMLEHPPDTTTPSEEPGGPQMLTSQAPCVDGFEEPGARQRALSAVSVLTSALEELEESRHKCPPCWNRLAQRYLIWECCPLWMSIKQGVKLVVMDPFTDLTITMCIVLNTLFMALEHYNMTSEFEEMLQVGNLVFTGIFTAEMTFKIIALDPYYYFQQGWNIFDSIIVILSLMELGLSRMSNLSVLRSFRLLRVFKLAKSWPTLNTLIKIIGNSVGALGNLTLVLAIIVFIFAVVGMQLFGKNYSELRDSDSGLLPRWHMMDFFHAFLIIFRILCGEWIETMWDCMEVSGQSLCLLVFLLVMVIGNLVVLNLFLALLLSSFSADNLTAPDEDREMNNLQLALARIQRGLRFVKRTTWDFCCGLLRQRPQKPAALAAQGQLPSCIATPYSPPPPETEKVPPTRKETRFEEGEQPGQGTPGDPEPVCVPIAVAESDTDDQEEDEENSLGTEEESSKQQESQPVSGGPEAPPDSRTWSQVSATASSEAEASASQADWRQQWKAEPQAPGCGETPEDSCSEGSTADMTNTAELLEQIPDLGQDVKDPEDCFTEGCVRRCPCCAVDTTQAPGKVWWRLRKTCYHIVEHSWFETFIIFMILLSSGALAFEDIYLEERKTIKVLLEYADKMFTYVFVLEMLLKWVAYGFKKYFTNAWCWLDFLIVDVSLVSLVANTLGFAEMGPIKSLRTLRALRPLRALSRFEGMRVVVNALVGAIPSIMNVLLVCLIFWLIFSIMGVNLFAGKFGRCINQTEGDLPLNYTIVNNKSQCESLNLTGELYWTKVKVNFDNVGAGYLALLQVATFKGWMDIMYAAVDSRGYEEQPQWEYNLYMYIYFVIFIIFGSFFTLNLFIGVIIDNFNQQKKKLGGQDIFMTEEQKKYYNAMKKLGSKKPQKPIPRPLNKYQGFIFDIVTKQAFDVTIMFLICLNMVTMMVETDDQSPEKINILAKINLLFVAIFTGECIVKLAALRHYYFTNSWNIFDFVVVILSIVGTVLSDIIQKYFFSPTLFRVIRLARIGRILRLIRGAKGIRTLLFALMMSLPALFNIGLLLFLVMFIYSIFGMANFAYVKWEAGIDDMFNFQTFANSMLCLFQITTSAGWDGLLSPILNTGPPYCDPTLPNSNGSRGDCGSPAVGILFFTTYIIISFLIVVNMYIAIILENFSVATEESTEPLSEDDFDMFYEIWEKFDPEATQFIEYSVLSDFADALSEPLRIAKPNQISLINMDLPMVSGDRIHCMDILFAFTKRVLGESGEMDALKIQMEEKFMAANPSKISYEPITTTLRRKHEEVSAMVIQRAFRRHLLQRSLKHASFLFRQQAGSGLSEEDAPEREGLIAYVMSENFSRPLGPPSSSSISSTSFPPSYDSVTRATSDNLQVRGSDYSHSEDLADFPPSPDRDRESIV'
    )
]

chains_neighbors_list= [
    ['A'], ['B', 'C'], ['D', 'E'], ['F'], ['G', 'H'], ['I', 'J', 'K', 'L'], 
    ['M', 'N'], ['O', 'P', 'Q'], ['R', 'S', 'T', 'U'], ['V', 'W'], ['X', 'Y'], 
    ['Z', 'a'], ['b', 'c'], ['d', 'e']
]
chains_neighbors_pdb_files= [
    '1cfd_cleaned_6871', '1cff_cleaned_apo_frame3_reindexed_truncated_14657',
    '1ckk_cleaned_apo_frame0_reindexed_14373', '1cll_cleaned_apo_9604',
    '1cm1_cleaned_apo_6095', '1g4y_cleaned_apo_renamed_truncated_reindexed_asym_11436',
    '1niw_cleaned_apo_chainAB_MET_12352', '1nwd_apo_truncated_reindexed_5348',
    '2f2p_cleaned_apo_reindexed_asym_9369', '2n8j_frame0_reindexed_2275',
    '2wel_cleaned_apo_truncated_reindexed_9656', '3ewt_cleaned_apo_2202',
    '3ewv_cleaned_apo_reindexed_6808', '4djc_cleaned_apo_reindexed_truncated_2279'
]

# load AF2 model parameters
haiku_parameters_dict= get_af_model_parameters(
    ['model_1_ptm', 'model_1_multimer_v3'], 
    af2_params_dir
)


def af2rank_list(use_surrogate_tied_residues= False, device= 'gpu'):
    return [
        ObjectiveAF2Rank(
            chain_ids= chain_neighbors,
            template_file_loc= f'{pdb_files_dir}/{pdb_file}.pdb',
            tmscore_exec= tmscore_exec,
            params_dir= af2_params_dir,
            device= device,
            sign_flip= True,
            use_surrogate_tied_residues= use_surrogate_tied_residues,
            persistent= True,
            haiku_parameters_dict= haiku_parameters_dict
        ) for chain_neighbors, pdb_file in zip(
            chains_neighbors_list, 
            chains_neighbors_pdb_files, 
            strict= True
        )
    ]

def protein_mpnn_list(use_surrogate_tied_residues= False, device= 'gpu'):
    return [
        ObjectiveProteinMPNNNegLogProb(
            chain_ids= chain_neighbors,
            pdb_file_name= pdb_file,
            score_type='all_positions',
            num_seqs= 5,
            model_weights_loc= protein_mpnn_weights_dir,
            device= device,
            sign_flip= False,
            use_surrogate_tied_residues= use_surrogate_tied_residues
        ) for chain_neighbors, pdb_file in zip(
            chains_neighbors_list, 
            chains_neighbors_pdb_files, 
            strict= True
        )
    ]


esm_device= 'gpu'

esm_sampler_dict= {
    'esm1v': ESM_sampler(model_map['esm1v'](), device= esm_device)
}

def esm_1v(design_chain= 'A'):
    return ObjectiveESM(
        chain_id= design_chain,
        model_name= 'esm1v',
        device= esm_device,
        sign_flip= True,
        esm_sampler_dict= esm_sampler_dict
    )
